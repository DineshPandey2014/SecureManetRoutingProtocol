var PORT_NODE_THREE = 44444;
var HOST_NODE_THREE = '127.0.0.1';
var crypto = require("crypto")
var dgram = require('dgram');
var server = dgram.createSocket('udp4');
var crypto = require("crypto")
server.bind(PORT_NODE_THREE, HOST_NODE_THREE);

console.log("--Inside Node Three--");

server.on('listening', function () {
    var address = server.address();
    console.log('UDP Server listening on ' + address.address + ":" + address.port);
});

server.on('message', function (message, remote) {
    var key = "p6L32vnOhCn+Re/n3F+4";
    var decryptedText = decrypt(key, message);
    console.log(remote.address + ':' + remote.port +' - ' + decryptedText);
    var status = "Data_Received_Successfully_From_Node_One_Via_Node_Two.";
    acknowledgementMessage(status);
});


function decrypt(key, data) {
    console.log("----data----"+data);
    var decipher = crypto.createDecipher('aes-256-cbc', key);
    decipher.setAutoPadding(auto_padding=false);
    var dcryptedBuffers = [decipher.update(new Buffer(data))];
    try {
        dcryptedBuffers.push(decipher.final());
    } catch(err){
        console.log("---Hello user, there is error.");
        var status = "Error Data Not Received";
        acknowledgementMessage(status);
        console("--Send the acknowledgment---");
    }
    var dcrypted = Buffer.concat(dcryptedBuffers)
        .toString('utf8');
    console.log("---dcrypted--"+dcrypted);
    return dcrypted;
    /*
     var decrypted = decipher.update(data, 'hex', 'utf-8');
     console.log("------User----"+decrypted);
     decrypted += decipher.final('utf-8');
     return decrypted;*/
}

function encrypt(key, data) {
    var cipher = crypto.createCipher('aes-256-cbc', key);
    var cryptedBuffers = [cipher.update(new Buffer(data))];
    cryptedBuffers.push(cipher.final());
    var crypted = Buffer.concat(cryptedBuffers);
    return crypted;
}

function acknowledgementMessage(status) {
    var PORT_NODE_FOUR = 60000;
    var HOST_NODE_FOUR = '127.0.0.1';
    var key = "p6L32vnOhCn+Re/n3F+4";
    var statusMessage = encrypt(key, status);
    var client = dgram.createSocket('udp4');
    var nodeThreestatusMessage = new Buffer(statusMessage);
    //console.log("Node Four After Buffer-->"+ nodeThreestatusMessage);
    client.send(nodeThreestatusMessage, 0, nodeThreestatusMessage.length, PORT_NODE_FOUR, HOST_NODE_FOUR,
        function(err, bytes) {
            if (err) throw err;
            console.log('UDP message sent to ' + HOST_NODE_FOUR +':'+ PORT_NODE_FOUR);
            //client.close();
        });

}